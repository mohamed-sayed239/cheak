<!-- استبدال جزء استقبال ومعالجة العرض -->
<script>
// ... الكود الحالي ...

// Listen for offer from broadcaster
const offerDoc = await db.collection('cameraConnections').doc('broadcaster').get();
if (offerDoc.exists) {
    const data = offerDoc.data();
    if (data.offer) {
        logDebug('تم استقبال عرض اتصال، جاري المعالجة...');
        // تحويل البيانات المستلمة إلى كائن RTCSessionDescription
        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
        
        // Create answer
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        logDebug('تم إنشاء إجابة الاتصال');
        
        // Send answer to Firestore (بتحويلها إلى JSON)
        await db.collection('cameraConnections').doc('viewerAnswer').set({
            answer: answer.toJSON()  // تحويل الإجابة إلى JSON
        });
        
        // ... بقية الكود ...
        
        // Listen for ICE candidates from broadcaster
        db.collection('cameraConnections').doc('broadcaster')
            .onSnapshot((doc) => {
                const data = doc.data();
                if (data && data.iceCandidates) {
                    logDebug(`استقبال ${data.iceCandidates.length} مرشح ICE`);
                    data.iceCandidates.forEach(candidate => {
                        const candidateString = JSON.stringify(candidate);
                        
                        if (!addedCandidates.has(candidateString)) {
                            addedCandidates.add(candidateString);
                            // تحويل البيانات إلى كائن RTCIceCandidate
                            peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
                                .then(() => logDebug('تمت إضافة مرشح ICE بنجاح'))
                                .catch(err => logDebug(`خطأ في إضافة مرشح ICE: ${err.message}`));
                        }
                    });
                }
            });
    }
}

// ... بقية الكود ...
</script>